<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cafe POS - Brewtopia</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bs-body-font-family: 'Inter', sans-serif;
    }

    body {
      background: #f2f4f7;
      margin: 0;
      padding: 0;
      padding-top: 64px;
      /* ‚Üê header height offset here */
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .page-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: #111827;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .header-tabs .btn {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: none;
      font-weight: 600;
      border-radius: 8px;
      padding: 0.5rem 1rem;
    }

    .header-tabs .btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .header-tabs .btn.active {
      background: white;
      color: #111827;
    }

    .logout-btn {
      background: linear-gradient(135deg, #374151, #1f2937);
      color: white;
      font-size: 13px;
      font-weight: 600;
      border-radius: 50px;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .logout-btn:hover {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }

    /* Main Layout */
    #main-content {
      height: 100%;
      padding: 1rem;
      overflow: hidden;
    }

    .view-container {
      display: none;
      height: 100%;
    }

    .view-container.active {
      display: flex;
    }

    .panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      /* ‚Üê prevents flex overflow */
    }

    .panel h3 {
      margin: 0 0 1rem 0;
      padding: 1rem 1.5rem 0;
      font-size: 1.35rem;
      font-weight: 700;
      color: #1f2937;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 0 1.5rem 1.5rem;
      min-height: 0;
      /* ‚Üê important for nested scrolling */
    }

    /* Custom Scrollbar */
    .panel-body::-webkit-scrollbar {
      width: 6px;
    }

    .panel-body::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    .panel-body::-webkit-scrollbar-thumb {
      background: #94a3b8;
      border-radius: 10px;
    }

    .panel-body::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* Menu Card */
    .menu-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.25s ease;
      border: 2px solid transparent;
    }

    .menu-card:hover {
      background: #eff6ff;
      border-color: #3b82f6;
      transform: translateY(-4px);
      box-shadow: 0 12px 25px rgba(59, 130, 246, 0.15);
    }

    .menu-name {
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.25rem;
    }

    .menu-price {
      font-weight: 700;
      color: #2563eb;
      font-size: 1.1rem;
    }

    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      gap: 0.75rem;
      font-size: 0.95rem;
    }

    /* Name takes as much space as needed */
    .cart-item .item-name {
      flex: 1;
      min-width: 0;
      /* prevents overflow */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
      color: #1f2937;
    }

    /* Controls stay fixed width */
    .cart-item .cart-controls {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 110px;
      /* enough for +/- and number */
      justify-content: center;
    }

    /* Price fixed width + right align */
    .cart-item .item-price {
      flex-shrink: 0;
      min-width: 80px;
      text-align: right;
      font-weight: 700;
      color: #2563eb;
    }

    .cart-controls button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: #e2e8f0;
      font-weight: bold;
      color: #475569;
    }

    .cart-controls button:hover {
      background: #cbd5e1;
    }

    /* Better name handling */
    .item-name {
      line-height: 1.4;
    }

    /* Make quantity look nicer */
    .cart-controls strong {
      min-width: 20px;
      text-align: center;
    }

    /* Visual separation */
    .cart-item:hover {
      background: #f1f5f9;
    }

    /* Order Item */
    .order {
      background: #f0fdf4;
      border-left: 5px solid #22c55e;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .order:hover {
      background: #dcfce7;
      transform: translateX(6px);
    }

    .order.completed {
      opacity: 0.6;
      background: #f3f4f6;
      position: relative;
    }

    .order.completed::after {
      content: "PAID";
      position: absolute;
      top: 8px;
      right: 8px;
      background: #bbf7d0;
      color: #16a34a;
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
    }

    /* Table Input */
    .table-input {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #f9fafb;
      border: 2px solid #e2e8f0;
      border-radius: 14px;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }

    .table-input:focus-within {
      border-color: #2563eb;
      background: #eff6ff;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
    }

    .table-input input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      width: 100%;
    }

    /* Receipt */
    .receipt {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .receipt-header h2 {
      text-align: center;
      margin: 0 0 0.5rem;
      font-size: 1.5rem;
    }

    .receipt-table {
      width: 100%;
      margin: 1rem 0;
    }

    .receipt-table th {
      text-align: left;
      padding-bottom: 0.5rem;
      font-weight: 600;
    }

    .receipt-total {
      font-size: 1.25rem;
      font-weight: 800;
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 2px dashed #333;
    }

    /* Reports */
    .summary-card {
      background: #f8fafc;
      border-radius: 14px;
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.2s;
    }

    .summary-card:hover {
      transform: translateY(-4px);
    }

    .summary-card h4 {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .summary-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
    }

    .top-items-table {
      font-size: 0.95rem;
    }

    .top-items-table th {
      background: #f1f5f9;
      font-weight: 600;
    }
  </style>
</head>

<body onload="fetchOrders()">

  <!-- Header -->
  <header class="page-header">
    <div class="fs-4">‚òï Cafe Brewtopia</div>
    <div class="header-tabs">
      <button class="btn active" data-view="pos">POS</button>
      <button class="btn" data-view="reports">Reports</button>
    </div>
    <button class="btn logout-btn" onclick="logout()">
      <span>üö™</span> Logout
    </button>
  </header>

  <div id="main-content" class="container-fluid h-100 px-3">

    <!-- POS View -->
    <div id="view-pos" class="view-container active row g-2 h-100">
      <!-- Menu -->
      <div class="col-lg-3 h-100">
        <div class="panel">
          <h3>‚òï Menu</h3>
          <div class="panel-body">
            <input type="text" class="form-control mb-3" id="menuSearch" placeholder="üîç Search menu items...">
            <small class="text-muted d-block mb-3" id="menuStats">Loading items...</small>
            <div id="menu"></div>
          </div>
        </div>
      </div>

      <!-- Cart -->
      <div class="col-lg-3 h-100">
        <div class="panel d-flex flex-column h-100">
          <h3>üßæ Cart</h3>

          <div class="panel-body d-flex flex-column" style="position: relative;">
            <!-- Table number input -->
            <div class="table-input mb-3">
              <span>üçΩÔ∏è</span>
              <input id="tableNo" type="number" placeholder="Enter Table Number">
            </div>

            <!-- Scrollable area for cart items -->
            <div id="cart" class="flex-grow-1 mb-4" style="overflow-y: auto; min-height: 120px;"></div>

            <!-- Fixed/sticky footer with total + button -->
            <div class="cart-sticky-footer mt-auto pt-3 border-top bg-white">
              <h5 class="mb-2 fw-bold">Total: ‚Çπ<span id="total">0</span></h5>
              <button class="btn btn-primary w-100" onclick="placeOrder()">
                Place / Update Order
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders -->
      <div class="col-lg-3 h-100">
        <div class="panel">
          <h3>üì¶ Live Orders</h3>
          <div class="panel-body">
            <div id="orders"></div>
            <hr class="my-4">
            <h5>üïò Previous Orders</h5>
            <div id="previousOrders"></div>
          </div>
        </div>
      </div>

      <!-- Bill -->
      <div class="col-lg-3 h-100">
        <div class="panel d-flex flex-column h-100">
          <h3>üßæ Bill</h3>

          <div class="panel-body d-flex flex-column">
            <!-- Scrollable bill content -->
            <div id="bill" class="flex-grow-1 overflow-auto mb-3"></div>

            <!-- Sticky buttons at bottom -->
            <div class="bill-sticky-footer mt-auto pt-3 border-top bg-white">
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary flex-fill" onclick="printBill()">
                  üñ® Print Bill
                </button>
                <button class="btn btn-success flex-fill" onclick="markPaid()">
                  üí∞ Mark Paid
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports View -->
    <div id="view-reports" class="view-container">
      <div class="panel h-100 w-100">
        <h3>üìä Sales Reports</h3>
        <div class="panel-body">
          <div class="row mb-4 align-items-end">
            <div class="col-md-4">
              <select id="reportPeriod" class="form-select" onchange="generateReport()">
                <option value="today" selected>Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="this-month">This Month</option>
                <option value="last-month">Last Month</option>
                <option value="this-year">This Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="col-md-5" id="customRange" style="display:none;">
              <div class="row g-2">
                <div class="col">
                  <input type="date" id="reportFrom" class="form-control">
                </div>
                <div class="col-auto d-flex align-items-center">to</div>
                <div class="col">
                  <input type="date" id="reportTo" class="form-control">
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" onclick="generateReport()">Generate Report</button>
            </div>
          </div>

          <div class="row g-3 mb-5">
            <div class="col-md-3">
              <div class="summary-card">
                <h4>Total Sales</h4>
                <div class="value" id="totalSales">‚Çπ0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <h4>Total Orders</h4>
                <div class="value" id="orderCount">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <h4>Avg Order</h4>
                <div class="value" id="avgOrder">‚Çπ0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <h4>Paid Orders</h4>
                <div class="value" id="paidCount">0</div>
              </div>
            </div>
          </div>

          <h4 class="mb-3">Top Selling Items</h4>
          <div class="table-responsive">
            <table class="table table-hover top-items-table">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th>Qty Sold</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody id="topItemsBody">
                <tr>
                  <td colspan="3" class="text-center text-muted py-5">Select a period to view report</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <script>
    // Your entire original JavaScript code below (100% unchanged)
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/login.html";

    const API = "http://localhost:4000";
    const socket = io(API);

    let menuCategories = [];
    let cart = [];
    let currentOrderId = null;
    let currentBillStatus = "UNPAID";
    let currentFilter = 'all';

    function fetchOrders() {
      $.ajax({
        url: API + "/api/orders/today",
        method: "GET",
        headers: { "Authorization": "Bearer " + token },
        success: function (orders) {
          const $live = $("#orders");
          const $previous = $("#previousOrders");
          $live.empty();
          $previous.empty();

          $.each(orders, function (i, order) {
            const $div = $("<div>", { class: "order", id: "order-" + order.id });
            $div.html(
              "<strong>Table " + order.tableNo + "</strong><br>" +
              "Order #" + order.id + "<br>" +
              "‚Çπ" + order.total
            );

            if (order.paid) {
              $div.addClass("completed");
              $div.on("click", function () { loadBill(order.id); });
              $previous.append($div);
            } else {
              $div.on("click", function () { editOrder(order.id); });
              $live.prepend($div);
            }
          });
        },
        error: function (xhr, status, error) {
          console.error("Error fetching orders:", status, error);
        }
      });
    }

    fetch(`${API}/api/menu`, {
      headers: { "Authorization": `Bearer ${token}` }
    })
      .then(res => {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem("token");
          window.location.href = "/login.html";
          throw new Error("Unauthorized");
        }
        return res.json();
      })
      .then(data => {
        menuCategories = data;
        renderMenu();
        updateMenuStats();
      })
      .catch(err => console.error("Menu load failed", err));

    function updateMenuStats() {
      const totalItems = menuCategories.reduce((sum, cat) => sum + (cat.items?.length || 0), 0);
      document.getElementById('menuStats').textContent = `${totalItems} items available`;
    }

    function renderMenu(searchTerm = '') {
      const div = document.getElementById("menu");
      div.innerHTML = "";

      let filteredCategories = menuCategories.filter(cat => {
        if (!cat.items || cat.items.length === 0) return false;
        if (searchTerm) {
          return cat.items.some(item => item.name.toLowerCase().includes(searchTerm));
        }
        return true;
      });

      if (filteredCategories.length === 0) {
        div.innerHTML = '<div class="text-muted text-center py-4">No items found</div>';
        return;
      }

      filteredCategories.forEach(cat => {
        const filteredItems = cat.items.filter(item => {
          return !searchTerm || item.name.toLowerCase().includes(searchTerm);
        });

        if (filteredItems.length === 0) return;

        div.innerHTML += `
          <div class="mb-4">
            <h6 class="fw-bold text-dark border-bottom pb-2 mb-3">${cat.name} (${filteredItems.length})</h6>
            <div class="row g-3">
              ${filteredItems.map(item => `
                <div class="col-6">
                  <div class="menu-card h-100 d-flex flex-column justify-content-between" onclick='addToCart(${JSON.stringify(item)})'>
                    <div>
                      ${item.popular ? '<small class="text-warning fw-bold">‚òÖ Popular</small>' : ''}
                      <div class="menu-name">${item.name}</div>
                    </div>
                    <div class="menu-price">‚Çπ${item.price}</div>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
      });
    }

    // ‚îÄ‚îÄ Live menu search ‚îÄ‚îÄ
    document.getElementById('menuSearch').addEventListener('input', function (e) {
      const searchTerm = e.target.value.toLowerCase().trim();
      renderMenu(searchTerm);
    });

    function addToCart(product) {
      const item = cart.find(i => i.id === product.id);
      if (item) item.qty++;
      else cart.push({ ...product, qty: 1 });
      renderCart();
    }

    function changeQty(index, delta) {
      cart[index].qty += delta;
      if (cart[index].qty <= 0) cart.splice(index, 1);
      renderCart();
    }

    function renderCart() {
      const div = document.getElementById("cart");
      div.innerHTML = "";
      let total = 0;

      cart.forEach((i, index) => {
        total += i.price * i.qty;
        div.innerHTML += `
          <div class="cart-item">
            <div>${i.name}</div>
            <div class="cart-controls d-flex align-items-center gap-2">
              <button class="btn btn-sm" onclick="changeQty(${index}, -1)">‚àí</button>
              <strong>${i.qty}</strong>
              <button class="btn btn-sm" onclick="changeQty(${index}, 1)">+</button>
            </div>
            <div class="text-end fw-bold">‚Çπ${i.price * i.qty}</div>
          </div>
        `;
      });

      document.getElementById("total").innerText = total;
    }

    async function placeOrder() {
      const tableNo = document.getElementById("tableNo").value.trim();
      if (!tableNo || cart.length === 0) {
        alert("Please enter table number and add some items");
        return;
      }

      const items = cart.map(i => ({
        menuItemId: i.id,
        quantity: i.qty
      }));

      const url = currentOrderId
        ? `${API}/api/orders/${currentOrderId}`
        : `${API}/api/orders`;

      const method = currentOrderId ? "PUT" : "POST";

      try {
        const response = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ tableNo, items })
        });

        if (!response.ok) throw new Error(`Server responded with ${response.status}`);

        cart = [];
        currentOrderId = null;
        renderCart();
        document.getElementById("tableNo").value = "";
      } catch (err) {
        console.error("Place order failed:", err);
        alert("Failed to save order. Please try again.");
      }
    }
    socket.on("new-order", order => {
      const div = document.createElement("div");
      div.className = "order";
      div.id = `order-${order.id}`;
      div.innerHTML = `<strong>Table ${order.tableNo}</strong><br>Order #${order.id}<br>‚Çπ${order.total}`;
      div.onclick = () => editOrder(order.id);
      document.getElementById("orders").prepend(div);
    });

    socket.on("order-updated", order => {
      const el = document.getElementById(`order-${order.id}`);
      if (!el || el.classList.contains("completed")) return;
      el.innerHTML = `<strong>Table ${order.tableNo}</strong><br>Order #${order.id}<br>‚Çπ${order.total}`;
    });

    socket.on("order-paid", order => {
      const el = document.getElementById(`order-${order.id}`);
      if (!el) return;
      el.classList.add("completed");
      el.onclick = () => loadBill(order.id);
      document.getElementById("previousOrders").prepend(el);
    });

    function editOrder(orderId) {
      fetch(`${API}/api/orders/${orderId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      })
        .then(res => res.json())
        .then(order => {
          currentOrderId = order.id;
          cart = [];
          document.getElementById("tableNo").value = order.tableNo;

          order.items.forEach(i => {
            cart.push({
              id: i.menuItem.id,
              name: i.menuItem.name,
              price: i.price,
              qty: i.quantity
            });
          });

          renderCart();
          loadBill(orderId);
        });
    }

    function loadBill(orderId) {
      fetch(`${API}/api/orders/${orderId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      })
        .then(res => res.json())
        .then(order => {
          document.getElementById("bill").innerHTML = `
          <div class="receipt">
            <div class="receipt-header">
              <h2>‚òï Cafe Brewtopia</h2>
              <div class="text-center text-muted small">
                Table ${order.tableNo}<br>
                ${new Date().toLocaleString()}
              </div>
            </div>
            <hr>
            <table class="receipt-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Amt</th>
                </tr>
              </thead>
              <tbody>
                ${order.items.map(i => `
                  <tr>
                    <td>${i.menuItem.name}</td>
                    <td class="text-center">${i.quantity}</td>
                    <td class="text-end">‚Çπ${i.price * i.quantity}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
            <div class="receipt-total">
              <span>Total</span>
              <span>‚Çπ${order.total}</span>
            </div>
            <div class="text-center small text-muted mt-3">
              Thank you for visiting! ‚ù§Ô∏è<br>Come again soon!
            </div>
          </div>
        `;
        });
    }

    function markPaid() {
      if (!currentOrderId) return alert("Select an order first");
      fetch(`${API}/api/orders/${currentOrderId}/pay`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}` }
      }).then(() => {
        currentOrderId = null;
        cart = [];
        document.getElementById("tableNo").value = "";
        document.getElementById("cart").innerHTML = "";
        document.getElementById("total").innerText = "0";
        document.getElementById("bill").innerHTML = "";
      });
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    }

    function printBill() {
      const billContent = document.getElementById("bill").innerHTML;
      if (!billContent.trim()) return alert("No bill to print");

      const printWindow = window.open("", "", "width=400,height=600");
      printWindow.document.write(`
        <!DOCTYPE html>
        <html><head><title>Bill</title>
        <style>
          body { font-family: 'Courier New', monospace; padding: 20px; background: white; }
          .receipt { max-width: 80mm; margin: auto; }
          table { width: 100%; font-size: 14px; }
          th, td { padding: 4px 0; }
          .text-end { text-align: right; }
          .text-center { text-align: center; }
          hr { border: 1px dashed #000; margin: 15px 0; }
        </style>
        </head><body>${billContent}</body></html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // Tab Switching
    document.querySelectorAll('.header-tabs .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.header-tabs .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${btn.dataset.view}`).classList.add('active');

        if (btn.dataset.view === 'reports') {
          document.getElementById('reportPeriod').value = 'today';
          document.getElementById('customRange').style.display = 'none';
          generateReport();
        }
      });
    });

    document.getElementById('reportPeriod').addEventListener('change', function () {
      document.getElementById('customRange').style.display = this.value === 'custom' ? 'flex' : 'none';
    });

    function generateReport() {
      const period = document.getElementById('reportPeriod').value;
      let from = '', to = '';

      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      switch (period) {
        case 'today': from = to = todayStr; break;
        case 'yesterday':
          const yd = new Date(today);
          yd.setDate(yd.getDate() - 1);
          from = to = yd.toISOString().split('T')[0]; break;
        case 'this-month':
          from = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
          to = todayStr; break;
        case 'last-month':
          const lm = new Date(today);
          lm.setMonth(lm.getMonth() - 1);
          from = `${lm.getFullYear()}-${String(lm.getMonth() + 1).padStart(2, '0')}-01`;
          to = new Date(lm.getFullYear(), lm.getMonth() + 1, 0).toISOString().split('T')[0]; break;
        case 'this-year':
          from = `${today.getFullYear()}-01-01`;
          to = todayStr; break;
        case 'custom':
          from = document.getElementById('reportFrom').value;
          to = document.getElementById('reportTo').value;
          if (!from || !to) return alert("Please select both dates");
          break;
      }

      document.getElementById('totalSales').textContent = 'Loading...';
      document.getElementById('orderCount').textContent = 'Loading...';
      document.getElementById('avgOrder').textContent = 'Loading...';
      document.getElementById('paidCount').textContent = 'Loading...';
      document.getElementById('topItemsBody').innerHTML = '<tr><td colspan="3" class="text-center py-5 text-muted">Loading...</td></tr>';

      fetch(`${API}/api/orders/report/summary?from=${from}&to=${to}`, {
        headers: { "Authorization": `Bearer ${token}` }
      })
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
          document.getElementById('totalSales').textContent = `‚Çπ${Number(data.totalSales || 0).toLocaleString('en-IN')}`;
          document.getElementById('orderCount').textContent = Number(data.orderCount || 0).toLocaleString('en-IN');
          document.getElementById('avgOrder').textContent = `‚Çπ${Number(data.avgOrderValue || 0).toFixed(0)}`;
          document.getElementById('paidCount').textContent = Number(data.paidCount || 0).toLocaleString('en-IN');

          const tbody = document.getElementById('topItemsBody');
          tbody.innerHTML = '';
          if (data.topItems?.length > 0) {
            data.topItems.forEach(item => {
              tbody.innerHTML += `<tr>
                <td>${item.name}</td>
                <td>${Number(item.qty).toLocaleString('en-IN')}</td>
                <td>‚Çπ${Number(item.revenue || 0).toLocaleString('en-IN')}</td>
              </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-5">No sales in this period</td></tr>';
          }
        })
        .catch(() => {
          document.getElementById('topItemsBody').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Failed to load</td></tr>';
        });
    }
  </script>
</body>

</html>